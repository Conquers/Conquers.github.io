

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="wtt">
  <meta name="keywords" content="">
  
    <meta name="description" content="第17章 其他数据库日志我们在讲解数据库事务时，讲过两种日志：重做日志(redo日志)、回滚日志(undo日志)。 对于线上数据库应用系统，突然遭遇数据库宕机怎么办？在这种情况下，定位宕机的原因就非常关键。我们可以查看数据库的错误日志。因为日志中记录了数据库运行中的诊断信息，包括了错误、警告和注释等信息。比如：从日志中发现某个连接中的SQL操作发生了死循环，导致内存不足，被系统强行终止了。明确了原">
<meta property="og:type" content="article">
<meta property="og:title" content="第17章 其他数据库日志">
<meta property="og:url" content="http://conquers.github.io/posts/1c2dcbdd.html">
<meta property="og:site_name" content="wtt&#39;s Blog">
<meta property="og:description" content="第17章 其他数据库日志我们在讲解数据库事务时，讲过两种日志：重做日志(redo日志)、回滚日志(undo日志)。 对于线上数据库应用系统，突然遭遇数据库宕机怎么办？在这种情况下，定位宕机的原因就非常关键。我们可以查看数据库的错误日志。因为日志中记录了数据库运行中的诊断信息，包括了错误、警告和注释等信息。比如：从日志中发现某个连接中的SQL操作发生了死循环，导致内存不足，被系统强行终止了。明确了原">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://conquers.github.io/Resources/default.png">
<meta property="article:published_time" content="2023-06-27T01:39:10.000Z">
<meta property="article:modified_time" content="2023-07-18T02:42:52.330Z">
<meta property="article:author" content="wtt">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://conquers.github.io/Resources/default.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>第17章 其他数据库日志 - wtt&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/mac.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"conquers.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wtt's Blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>wtt&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="第17章 其他数据库日志"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-27 09:39" pubdate>
          2023年6月27日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          26k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          215 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第17章 其他数据库日志</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="第17章-其他数据库日志"><a href="#第17章-其他数据库日志" class="headerlink" title="第17章 其他数据库日志"></a>第17章 其他数据库日志</h1><p>我们在讲解数据库事务时，讲过两种日志：<a href="%E7%AC%AC14%E7%AB%A0%20MySQL%20%E6%97%A5%E5%BF%97.md#1%E3%80%81redo%E6%97%A5%E5%BF%97">重做日志(redo日志)</a>、<a href="%E7%AC%AC14%E7%AB%A0%20MySQL%20%E6%97%A5%E5%BF%97.md#2%E3%80%81Undo%E6%97%A5%E5%BF%97">回滚日志(undo日志)</a>。</p>
<p>对于线上数据库应用系统，突然遭遇数据库宕机怎么办？在这种情况下，定位宕机的原因就非常关键。我们可以查看数据库的错误日志。因为日志中记录了数据库运行中的诊断信息，包括了错误、警告和注释等信息。比如：从日志中发现某个连接中的SQL操作发生了死循环，导致内存不足，被系统强行终止了。明确了原因，处理起来也就轻松了，系统很快就恢复了运行。</p>
<p>除了发现错误，日志在数据复制、数据恢复、操作审计，以及确保数据的永久性和一致性等方面，都有着不可替代的作用。</p>
<p><strong>千万不要小看日志</strong>。很多看似奇怪的问题，答案往往就藏在日志里。很多情况下，只有通过查看日志才能发现问题的原因，真正解决问题。所以，一定要学会查看日志，养成检查日志的习惯，对提升你的数据库应用开发能力至关重要。</p>
<p><code>MySQL8.0</code> 官网日志地址： <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/server-logs.html">https://dev.mysql.com/doc/refman/8.0/en/server-logs.html</a> </p>
<h2 id="1-MySQL支持的日志"><a href="#1-MySQL支持的日志" class="headerlink" title="1. MySQL支持的日志"></a>1. MySQL支持的日志</h2><h3 id="1-1-日志类型"><a href="#1-1-日志类型" class="headerlink" title="1.1 日志类型"></a>1.1 日志类型</h3><p><code>MySQL</code> 有不同类型的日志文件，用来存储不同类型的日志，分为 <strong>二进制日志</strong> 、 <strong>错误日志</strong> 、<strong>通用查询日志</strong> 和 <strong>慢查询日志</strong> ，这也是常用的4种。<code>MySQL 8</code> 又新增两种支持的日志： <strong>中继日志</strong> 和 <strong>数据定义语句日志</strong>。使用这些日志文件，可以查看 <code>MySQL</code> 内部发生的事情。</p>
<p>综上，<code>MySQL</code> 的日志可分为如下6类：</p>
<ul>
<li><strong>慢查询日志</strong>：记录所有执行时间超过 <code>long_query_time</code> 的所有查询，方便我们对查询进行优化。 </li>
<li><strong>通用查询日志</strong>：记录所有连接的起始时间和终止时间，以及连接发送给数据库服务器的所有指令， 对我们复原操作的实际场景、发现问题，甚至是对数据库操作的审计都有很大的帮助。 </li>
<li><strong>错误日志</strong>：记录 <code>MySQL</code> 服务的启动、运行或停止 <code>MySQL</code> 服务时出现的问题，方便我们了解服务器的状态，从而对服务器进行维护。 </li>
<li><strong>二进制日志</strong>：记录所有更改数据的语句，可以用于主从服务器之间的数据同步，以及服务器遇到故障时数据的无损失恢复。 </li>
<li><strong>中继日志</strong>：用于主从服务器架构中，从服务器用来存放主服务器二进制日志内容的一个中间文件。 从服务器通过读取中继日志的内容，来同步主服务器上的操作。 </li>
<li><strong>数据定义语句日志</strong>：记录数据定义语句执行的元数据操作。</li>
</ul>
<p>除二进制日志外，其他日志都是 <strong>文本文件</strong>。默认情况下，所有日志创建于 <strong>MySQL数据目录</strong> 中。</p>
<h3 id="1-2-日志的弊端"><a href="#1-2-日志的弊端" class="headerlink" title="1.2 日志的弊端"></a>1.2 日志的弊端</h3><ul>
<li>日志功能会<strong>降低MySQL数据库的性能</strong>。例如，在查询非常频繁的MySQL数据库系统中，如果开启了通用查询日志和慢查询日志，MySQL数据库会花费很多时间记录日志。</li>
<li>日志会<strong>占用大量的磁盘空间</strong>。对于用户量非常大，操作非常频繁的数据库，日志文件需要的存储空间设置比数据库文件需要的存储空间还要大。</li>
</ul>
<h2 id="2-慢查询日志-slow-query-log"><a href="#2-慢查询日志-slow-query-log" class="headerlink" title="2. 慢查询日志(slow query log)"></a>2. 慢查询日志(slow query log)</h2><p>前面章节《第09章_性能分析工具的使用》已经详细讲述。</p>
<h2 id="3-通用查询日志-general-query-log"><a href="#3-通用查询日志-general-query-log" class="headerlink" title="3. 通用查询日志(general query log)"></a>3. 通用查询日志(general query log)</h2><p>通用查询日志用来<strong>记录用户的所有操作</strong>，包括启动和关闭MySQL服务、所有用户的连接开始时间和截止时间、发给 MySQL 数据库服务器的所有 SQL 指令等。当我们的数据发生异常时，查看通用查询日志， 还原操作时的具体场景，可以帮助我们准确定位问题。</p>
<h3 id="3-1-问题场景"><a href="#3-1-问题场景" class="headerlink" title="3.1 问题场景"></a>3.1 问题场景</h3><p>在电商系统中，购买商品并且使用微信支付完成以后，却发现支付中心的记录并没有新增，此时用户再次使用支付宝支付，就会出现重复支付的问题。但是当去数据库中查询数据的时候，会发现只有一条记录存在。那么此时给到的现象就是只有一条支付记录，但是用户却支付了两次。</p>
<p>我们对系统进行了仔细检查，没有发现数据问题，因为用户编号和订单编号以及第三方流水号都是对的。可是用户确实支付了两次，这个时候，我们想到了检查通用查询日志，看看当天到底发生了什么。</p>
<p>查看之后，发现: 1月1日下午2点，用户使用微信支付完以后，但是由于网络故障，支付中心没有及时收到微信支付的回调通知，导致当时没有写入数据。1月1日下午2点30，用户又使用支付宝支付，此时记录更新到支付中心。1月1日晚上9点，微信的回调通知过来了，但是支付中心已经存在了支付宝的记录，所以只能覆盖记录了。</p>
<p>由于网络的原因导致了重复支付。至于解决问题的方案就很多了，这里省略。</p>
<p>可以看到通用查询日志可以帮助我们了解操作发生的具体时间和操作的细节，对找出异常发生的原因极其关键。</p>
<h3 id="3-2-查看当前状态"><a href="#3-2-查看当前状态" class="headerlink" title="3.2 查看当前状态"></a>3.2 查看当前状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; SHOW VARIABLES LIKE &#x27;%general%&#x27;;<br>+------------------+---------------------------------+<br>| Variable_name    | Value                           |<br>+------------------+---------------------------------+<br>| general_log      | OFF                             | #通用查询日志处于关闭状态<br>| general_log_file | /var/lib/mysql/c2879930f2c0.log | #通用查询日志文件的名称是c2879930f2c0.log<br>+------------------+---------------------------------+<br></code></pre></td></tr></table></figure>

<p>参数说明如下：</p>
<ul>
<li><code>general_log</code><ul>
<li>通用查询日志文件是否开启</li>
<li>在 <code>MySQL</code> 中，这个参数的默认值是关闭的。因为一旦开启记录通用查询日志，MySQL会记录所有的连接起止和相关的SQL操作，这样会消耗系统资源并且占用磁盘空间。我们可以通过手动修改变量的值，在需要的时候开启日志。</li>
</ul>
</li>
<li><code>general_log_file</code><ul>
<li>通用查询日志文件存放的路径及文件名。</li>
</ul>
</li>
</ul>
<h3 id="3-3-启动日志"><a href="#3-3-启动日志" class="headerlink" title="3.3 启动日志"></a>3.3 启动日志</h3><p><strong>方式1：永久性方式</strong></p>
<p>修改 <code>my.cnf</code> 或者 <code>my.ini</code> 配置文件来设置。在 <code>[mysqld]</code> 组下加入log选项，并重启 <code>MySQL</code> 服务。格式如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[mysqld]</span><br><span class="hljs-attr">general_log</span>=<span class="hljs-string">ON</span><br><span class="hljs-attr">general_log_file</span>=<span class="hljs-string">[path[filename]] #日志文件所在目录路径，filename为日志文件</span><br></code></pre></td></tr></table></figure>

<p>如果不指定目录和文件名，通用查询日志将默认存储在 <code>MySQL</code> 数据目录中的 <code>hostname.log</code> 文件中， <code>hostname</code> 表示主机名。</p>
<p><strong>方式2：临时性方式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; SET GLOBAL general_log = on; # 开启通用查询日志<br><br>mysql&gt; SET GLOBAL general_log_file = &#x27;path/filename&#x27;; # 设置日志文件保存位置<br></code></pre></td></tr></table></figure>

<p>查看设置后情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; SHOW VARIABLES LIKE &#x27;general_log%&#x27;;<br></code></pre></td></tr></table></figure>

<h3 id="3-4-查看日志"><a href="#3-4-查看日志" class="headerlink" title="3.4 查看日志"></a>3.4 查看日志</h3><p>开启通用查询日志后，测试几条SQL语句后：</p>
<p><img src="/Resources/image-20230627103632142.png" srcset="/img/loading.gif" lazyload alt="image-20230627103632142"></p>
<p>查看 <code>log</code> 文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqld, Version: 5.7.36 (MySQL Community Server (GPL)). started with:<br>Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock<br>Time                 Id Command    Argument<br>2023-06-27T02:34:43.354008Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:43.403308Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:43.450189Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ select database()<br>2023-06-27T02:34:43.501622Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:43.552641Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:49.804912Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:49.852126Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ set session transaction read write<br>2023-06-27T02:34:49.898693Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:34:49.953360Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:50.005019Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:34:50.051358Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ SET net_write_timeout=600<br>2023-06-27T02:34:50.097173Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ BEGIN<br>2023-06-27T02:34:50.143582Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:50.193090Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:50.242759Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ select database()<br>2023-06-27T02:34:50.292829Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:50.346224Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:55.233684Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:55.282385Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ set session transaction read write<br>2023-06-27T02:34:55.330868Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:34:55.406522Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:55.457117Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:34:55.505118Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ SET net_write_timeout=600<br>2023-06-27T02:34:55.552632Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ UPDATE student SET name= &#x27;李四&#x27; WHERE id = 1<br>2023-06-27T02:34:55.600166Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:55.649062Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:55.695927Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ select database()<br>2023-06-27T02:34:55.755790Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:55.806374Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:58.052279Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:58.099274Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ set session transaction read write<br>2023-06-27T02:34:58.150121Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:34:58.215392Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:58.263208Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:34:58.309709Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ SET net_write_timeout=600<br>2023-06-27T02:34:58.354610Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ UPDATE student SET name= &#x27;王五&#x27; WHERE id = 1<br>2023-06-27T02:34:58.400094Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:58.452835Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:58.498892Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ select database()<br>2023-06-27T02:34:58.572430Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:34:58.628693Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:34:59.954468Z	 1733 Query	SELECT @@session.transaction_isolation<br>2023-06-27T02:35:00.001524Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ set session transaction read write<br>2023-06-27T02:35:00.049937Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:35:00.104831Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:35:00.155706Z	 1733 Query	SELECT @@session.transaction_read_only<br>2023-06-27T02:35:00.200566Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ SET net_write_timeout=600<br>2023-06-27T02:35:00.247280Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ COMMIT<br>2023-06-27T02:35:00.299162Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:35:00.356189Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:35:00.401945Z	 1733 Query	/* ApplicationName=DataGrip 2023.1.2 */ select database()<br>2023-06-27T02:35:00.453672Z	 1733 Query	SHOW WARNINGS<br>2023-06-27T02:35:00.500196Z	 1733 Query	SELECT @@session.transaction_isolation<br><br></code></pre></td></tr></table></figure>

<p>在通用查询日志里面，我们可以清楚地看到，什么时候开启了新的客户端登陆数据库，登录之后做了什么 SQL 操作，针对的是哪个数据表等信息。</p>
<h3 id="3-5-停止日志"><a href="#3-5-停止日志" class="headerlink" title="3.5 停止日志"></a>3.5 停止日志</h3><p><strong>方式1：永久性方式</strong></p>
<p>修改 <code>my.cnf</code> 或者 <code>my.ini</code> 文件，把 <code>[mysqld]</code> 组下的 <code>general_log</code> 值设置为 <code>OFF</code> 或者把 <code>general_log</code> 一项注释掉。修改保存后，再<code>重启MySQL服务</code> ，即可生效。 </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># OFF</span><br><span class="hljs-attr">[mysqld]</span><br><span class="hljs-attr">general_log</span>=<span class="hljs-string">OFF</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 注释</span><br><span class="hljs-attr">[mysqld]</span><br><span class="hljs-comment">#general_log=ON</span><br></code></pre></td></tr></table></figure>

<p><strong>方式2：临时性方式</strong></p>
<p>使用SET语句停止MySQL通用查询日志功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; SET GLOBAL general_log = off;<br></code></pre></td></tr></table></figure>

<h3 id="3-6-删除-刷新日志"><a href="#3-6-删除-刷新日志" class="headerlink" title="3.6 删除\刷新日志"></a>3.6 删除\刷新日志</h3><p>如果数据的使用非常频繁，那么通用查询日志会占用服务器非常大的磁盘空间。数据管理员可以删除很长时间之前的查询日志，以保证MySQL服务器上的硬盘空间。</p>
<p><strong>手动删除文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 查看日志文件路径<br>mysql&gt; SHOW VARIABLES LIKE &#x27;general_log%&#x27;;<br><br># 手动删除通用查询日志<br></code></pre></td></tr></table></figure>

<p>使用如下命令重新生成查询日志文件，具体命令如下：前提一定要开启通用日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqladmin -uroot -p flush-logs<br><br># 补充<br>flush-logs指令操作：<br>MySQL 5.5.7以前的版本，flush-logs将错误日志文件重命名为filename.err_old,并创建新的日志文件。<br>MySQL 5.5.7开始，flush-logs只是重新打开日志文件，并不做日志备份和创建的操作。<br>如果日志文件不存在，MySQL启动或者执行flush-logs时会自动创建新的日志文件。重新创建错误日志，大小为0字节。<br></code></pre></td></tr></table></figure>

<p>如果希望备份旧的通用查询日志，就必须先将旧的日志文件复制出来或者改名，然后执行上面的mysqladmin命令。正确流程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># MySQL 直接安装在本地的</span><br> <span class="hljs-comment"># 进入通用日志文件目录</span><br><span class="hljs-built_in">cd</span> 通用日志文件所在目录 <br><span class="hljs-comment"># 改名</span><br><span class="hljs-built_in">mv</span> 通用日志文件名.<span class="hljs-built_in">log</span> 通用日志文件名.log.old<br><span class="hljs-comment"># 重新生成日志</span><br>mysqladmin -uroot -p flush-logs<br><br><br>------------------------------------------------------------------------------------<br><span class="hljs-comment">#  MySQL  安装在Docker容器中的</span><br><span class="hljs-comment"># 进入通用日志文件目录</span><br><span class="hljs-built_in">cd</span> /mydata/mysql/data<br><span class="hljs-comment"># 改名</span><br><span class="hljs-built_in">mv</span> c2879930f2c0.log c2879930f2c0.log.old<br><span class="hljs-comment">#  进入docker容器</span><br>docker <span class="hljs-built_in">exec</span> -it mysql /bin/bash<br><span class="hljs-comment"># 重新生成日志</span><br>mysqladmin -uroot -p flush-logs<br><span class="hljs-comment"># 日志内容如下</span><br>mysqld, Version: 5.7.36 (MySQL Community Server (GPL)). started with:<br>Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock<br>Time                 Id Command    Argument<br>2023-06-27T02:47:08.461732Z	 1739 Quit	<br></code></pre></td></tr></table></figure>

<h2 id="4-错误日志-error-log"><a href="#4-错误日志-error-log" class="headerlink" title="4. 错误日志(error log)"></a>4. 错误日志(error log)</h2><p>错误日志记录了 <code>MySQL</code> 服务器启动、停止运行的时间，以及系统启动、运行和停止过程中的诊断信息，包括错误、警告和提示等。</p>
<p>通过错误日志可以查看系统的运行状态，便于即时发现故障、修复故障。如果 <code>MySQL</code> 服务出现异常，错误日志是发现问题、解决故障的首选。</p>
<h3 id="4-1-查看日志"><a href="#4-1-查看日志" class="headerlink" title="4.1 查看日志"></a>4.1 查看日志</h3><p>在 <code>MySQL</code> 数据库中，错误日志功能是<strong>默认开启</strong>且<strong>无法被禁止</strong>。</p>
<p>查询错误日志的存储路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># MySQL 5.7 <br>mysql&gt; mysql&gt; SHOW VARIABLES LIKE &#x27;log_err%&#x27;;<br>+-------------------+------+<br>|Variable_name      |Value |<br>+-------------------+------+<br>|log_error          |stderr|<br>|log_error_verbosity|3     |<br>+-------------------+------+<br><br><br># MySQL 8 <br>mysql&gt; SHOW VARIABLES LIKE &#x27;log_err%&#x27;;<br>+--------------------------+--------------------------------------+<br>|Variable_name             |Value                                 |<br>+--------------------------+--------------------------------------+<br>|log_error                 |stderr                                |<br>|log_error_services        |log_filter_internal; log_sink_internal|<br>|log_error_suppression_list|                                      |<br>|log_error_verbosity       |2                                     |<br>+--------------------------+--------------------------------------+<br><br><br># 老师的路径<br>mysql&gt; SHOW VARIABLES LIKE &#x27;log_err%&#x27;;<br>+----------------------------+----------------------------------------+<br>| Variable_name              | Value                                  |<br>+----------------------------+----------------------------------------+<br>| log_error                  | /var/log/mysqld.log                    |<br>| log_error_services         | log_filter_internal; log_sink_internal |<br>| log_error_suppression_list |                                        |<br>| log_error_verbosity        | 2                                      |<br>+----------------------------+----------------------------------------+<br></code></pre></td></tr></table></figure>

<blockquote>
<p>可能是安装的方式不同，使用 <code>docker</code> 容器安装的 <code>MySQL 5.7</code> 和 <code>MySQL 8</code> 的错误日志都是 <code>stderr</code>，而老师的路径是<code>/var/log/mysqld.log</code></p>
<p><code>stderr</code>：<strong>标准错误输出</strong>，错误日志路径是 <code>console</code>；如果需要写入文件中，见 4.2 部分。</p>
</blockquote>
<h3 id="4-2-修改日志路径"><a href="#4-2-修改日志路径" class="headerlink" title="4.2 修改日志路径"></a>4.2 修改日志路径</h3><p><del>默认情况下，错误日志存储在 <code>MySQL</code> 数据库的数据文件夹下，名称默认为 <code>mysqld.log</code> （Linux系统）或 <code>hostname.err</code> （mac&#x2F;unix系统）。</del></p>
<p>如果需要指定文件名和路径，则需要在 <code>my.cnf</code> 或者 <code>my.ini</code> 中做如下配置：</p>
<p>以 <code>MySQL 5.7</code> 为例，配置错误日志文件路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>log-error=<span class="hljs-string">&#x27;/var/log/mysql/error.log&#x27;</span><br></code></pre></td></tr></table></figure>

<p>如果是使用的是 <code>Docker</code> 容器中的 <code>MySQL</code>，可能会出现 <code>Permission denied</code>，这是因为 <code>Docker</code> 容器中启动 <code>MySQL</code> 服务的是 <code>mysql</code> 用户。而我们宿主机中是没有 <code>mysql</code> 这个用户存在的，所以产生了 <code>Permission denied</code> 这个错误类型。</p>
<p>解决方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it mysql /bin/bash<br><br><span class="hljs-comment">#  给权限</span><br><span class="hljs-built_in">cd</span> /var/log<br><span class="hljs-built_in">chmod</span> 777 mysql<br><br><span class="hljs-comment"># 重启mysql容器</span><br>docker restart mysql<br></code></pre></td></tr></table></figure>

<h3 id="4-3-删除-刷新日志"><a href="#4-3-删除-刷新日志" class="headerlink" title="4.3 删除\刷新日志"></a>4.3 删除\刷新日志</h3><p>对于很久以前的错误日志，数据库管理员查看这些错误日志的可能性不大，可以将这些错误日志删除， 节省 <code>MySQL</code> 服务器上的硬盘空间。MySQL的错误日志是以文本文件的形式存储在文件系统中的，可以直接删除。</p>
<ul>
<li><p>删除日志</p>
<ul>
<li><p>在运行状态下删除错误日志文件后，MySQL并不会自动创建日志文件。</p>
</li>
<li><pre><code class="bash"># 直接删除
rm -f /mydata/mysql/log/error.log
# 间接删除 - 改名
mv /mydata/mysql/log/error.log /mydata/mysql/log/error.log.log
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><br>- 重建日志<br><br>  - ```bash<br>    <span class="hljs-comment"># 进入docker 容器</span><br>    docker exec -<span class="hljs-keyword">it</span> mysql /bin/bash<br>    <span class="hljs-comment"># 重建日志</span><br>    mysqladmin -uroot -p flush-logs<br>    <br>    <span class="hljs-comment"># 老师出现的错误，我这里前面给了777权限，这里就没有报错了，如果出现了错误，可以参考一下</span><br>    mysqladmin: refresh failed; <span class="hljs-keyword">error</span>: &#x27;Could <span class="hljs-keyword">not</span> open <span class="hljs-built_in">file</span> &#x27;/var/<span class="hljs-built_in">log</span>/mysqld.<span class="hljs-built_in">log</span>&#x27; <span class="hljs-keyword">for</span><br>    <span class="hljs-keyword">error</span> logging.&#x27;<br>    <br>    install -omysql -gmysql -m0644 /dev/null /var/<span class="hljs-built_in">log</span>/mysqld.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="4-4-MySQL-8-0-新特性"><a href="#4-4-MySQL-8-0-新特性" class="headerlink" title="4.4 MySQL 8.0 新特性"></a>4.4 MySQL 8.0 新特性</h3><p><code>MySQL8.0</code> 里对错误日志的改进。<code>MySQL8.0</code> 的错误日志可以理解为一个全新的日志，在这个版本里，接受了来自社区的广泛批评意见，在这些意见和建议的基础上生成了新的日志。</p>
<p>下面这些是来自社区的意见：</p>
<ul>
<li>默认情况下内容过于冗长</li>
<li>遗漏了有用的信息</li>
<li>难以过滤某些信息</li>
<li>没有标识错误信息的子系统源</li>
<li>没有错误代码，解析消息需要识别错误。引导消息可能会丢失</li>
<li>固定格式</li>
</ul>
<p>针对这些意见，MySQL做了如下改变：</p>
<ul>
<li>采用组件架构，通过不同的组件执行日志的写入和过滤功能</li>
<li>写入错误日志的全部信息都具有唯一的错误代码从10000开始</li>
<li>增加了一个新的消息分类《system》用于在错误日志中始终可见的非错误但服务器状态更改事件的消息</li>
<li>增加了额外的附加信息，例如关机时的版本信息，谁发起的关机等等</li>
<li>两种过滤方式：Internal和Dragnet</li>
<li>三种写入形式：经典、JSON和syseventlog</li>
</ul>
<blockquote>
<p>小结：</p>
<p>通常情况下，管理员不需要查看错误日志。但是，MySQL服务器发生异常时，管理员可以从错误日志中找到发生异常的时间、原因，然后根据这些信息来解决异常。</p>
</blockquote>
<h2 id="5-二进制日志-bin-log"><a href="#5-二进制日志-bin-log" class="headerlink" title="5. 二进制日志(bin log)"></a>5. 二进制日志(bin log)</h2><p><code>binlog: binary log</code>，二进制日志文件，也叫作变更日志（<code>update log</code>）。它记录了数据库所有执行的 <code>DDL</code> 和 <code>DML</code> 等数据库更新事件的语句，但是不包含没有修改任何数据的语句（如数据查询语句select、 show等）。</p>
<p>它以<strong>事件形式</strong>记录并保存在<strong>二进制文件</strong>中。通过这些信息，我们可以再现数据更新操作的全过程。</p>
<blockquote>
<p>如果想要记录所有语句（例如，为了识别有问题的查询），需要使用通用查询日志。</p>
</blockquote>
<p>binlog主要应用场景：</p>
<ul>
<li>一是用于<strong>数据恢复</strong>，如果 <code>MySQL</code> 数据库意外停止，可以通过二进制日志文件来查看用户执行了哪些操作，对数据库服务器文件做了哪些修改，然后根据二进制日志文件中的记录来恢复数据库服务器。</li>
<li>二是用于<strong>数据复制</strong>，由于日志的延续性和时效性，<code>master</code> 把它的二进制日志传递给 <code>slaves</code> 来达到 <code>master-slave</code> 数据一致的目的。</li>
</ul>
<p>可以说 <code>MySQL</code> 数据库的<strong>数据备份</strong>、<strong>主备</strong>、<strong>主主</strong>、<strong>主从</strong>都离不开 <code>binlog</code>，需要依靠 <code>binlog</code> 来同步数据，保证数据一致性。</p>
<p><img src="/Resources/image-20220715161842703.png" srcset="/img/loading.gif" lazyload alt="image-20220715161842703"></p>
<h3 id="5-1-查看默认情况"><a href="#5-1-查看默认情况" class="headerlink" title="5.1 查看默认情况"></a>5.1 查看默认情况</h3><p>查看记录二进制日志是否开启：在 <code>MySQL 8</code>中默认情况下，二进制文件是开启的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># MySQL 5 <br>mysql&gt; show variables like &#x27;%log_bin%&#x27;;<br>+-------------------------------+-----+<br>|Variable_name                  |Value|<br>+-------------------------------+-----+<br>|log_bin                        |OFF  |<br>|log_bin_basename               |     |<br>|log_bin_index                  |     |<br>|log_bin_trust_function_creators|OFF  |<br>|log_bin_use_v1_row_events      |OFF  |<br>|sql_log_bin                    |ON   |<br>+-------------------------------+-----+<br><br># MySQL 8 <br>mysql&gt; show variables like &#x27;%log_bin%&#x27;;<br>+-------------------------------+---------------------------+<br>|Variable_name                  |Value                      |<br>+-------------------------------+---------------------------+<br>|log_bin                        |ON                         |<br>|log_bin_basename               |/var/lib/mysql/binlog      |<br>|log_bin_index                  |/var/lib/mysql/binlog.index|<br>|log_bin_trust_function_creators|OFF                        |<br>|log_bin_use_v1_row_events      |OFF                        |<br>|sql_log_bin                    |ON                         |<br>+-------------------------------+---------------------------+<br></code></pre></td></tr></table></figure>

<p>部分参数说明：</p>
<ul>
<li><code>log_bin_basename</code>：是 <code>binlog</code> 日志的基本文件名，后面会追加标识来表示每一个文件</li>
<li><code>log_bin_index</code>：是 <code>binlog</code> 文件的索引文件，这个文件管理了所有的binlog文件的目录</li>
<li><code>log_bin_trust_function_creator</code>：限制存储过程，前面我们已经讲过了，这是因为二进制日志的一个重要功能是用于主从复制，而存储函数有可能导致主从的数据不一致。所以当开启二进制日志后，需要限制存储函数的创建、修改、调用</li>
<li><code>log_bin_use_v1_row_event</code>：此只读系统变量已弃用。ON表示使用版本 1 二进制日志行，OFF表示使用版本 2 二进制日志行(<code>MySQL 5.6</code> 的默认值为2)。</li>
</ul>
<h3 id="5-2-日志参数设置"><a href="#5-2-日志参数设置" class="headerlink" title="5.2 日志参数设置"></a>5.2 日志参数设置</h3><p><strong>方式1：永久性方式</strong></p>
<p>以 <code>MySQL 5.7</code> 为例，修改 <code>MySQL</code> 的 <code>my.cnf</code> 或 <code>my.ini</code> 文件可以设置二进制日志的相关参数：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># MySQL 5.7</span><br><span class="hljs-attr">[mysqld]</span><br><span class="hljs-comment">#启用二进制日志</span><br><span class="hljs-attr">log-bin</span>=<span class="hljs-string">atguigu-bin</span><br><span class="hljs-attr">server_id</span>=<span class="hljs-string">1 </span><br><span class="hljs-comment"># 服务器ID是必需的</span><br><span class="hljs-comment"># expire_logs_days = 5 可选</span><br><span class="hljs-comment"># max_binlog_size = 100m</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># MySQL 8</span><br><span class="hljs-attr">[mysqld]</span><br><span class="hljs-comment">#启用二进制日志</span><br><span class="hljs-attr">log-bin</span>=<span class="hljs-string">atguigu-bin</span><br><span class="hljs-attr">binlog_expire_logs_seconds</span>=<span class="hljs-string">600</span><br><span class="hljs-attr">max_binlog_size</span>=<span class="hljs-string">100M</span><br></code></pre></td></tr></table></figure>

<p>部分参数说明：</p>
<ul>
<li><code>log-bin=atguigu-bin</code>： <code>bin_log</code> 的名字，也可以加上全路径，如 <code>/home/mysql_bin_log/mysql-bin</code></li>
<li><code>binlog_expire_logs_seconds</code>：二进制日志文件保留的时长，单位是秒，默认2592000。</li>
<li><code>max_binlog_size</code>：单个二进制日志大小，当前日志文件大小超过此变量时，执行切换动作。此参数的最大和默认值是1GB，<strong>该设置并不能严格控制 <code>binlog</code> 的大小</strong>，尤其是 <code>binlog</code> 比较靠近最大值而又遇到一个比较大事务时，为了保证事务的完整性，可能不做切换日志的动作，只能将该事务的所有SQL都记录进当前日志，直到事务结束。一般情况下可采取默认值。</li>
</ul>
<p>重新启动 <code>MySQL</code> 服务，查询二进制日志的信息，执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show variables like &#x27;%log_bin%&#x27;;<br># 这里修改完配置文件，重启MySQL后，再次查看 bin_log 相关信息后，之前空着的两行已经有了数据<br>+-------------------------------+--------------------------------+<br>|Variable_name                  |Value                           |<br>+-------------------------------+--------------------------------+<br>|log_bin                        |ON                              |<br>|log_bin_basename               |/var/lib/mysql/atguigu-bin      |<br>|log_bin_index                  |/var/lib/mysql/atguigu-bin.index|<br>|log_bin_trust_function_creators|OFF                             |<br>|log_bin_use_v1_row_events      |OFF                             |<br>|sql_log_bin                    |ON                              |<br>+-------------------------------+--------------------------------+<br></code></pre></td></tr></table></figure>

<p><strong>设置带文件夹的bin-log日志存放目录</strong></p>
<p>如果想改变日志文件的目录和名称，可以对 <code>my.cnf</code> 或 <code>my.ini</code> 中的 <code>log_bin</code> 参数修改如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[mysqld]</span><br><span class="hljs-attr">log-bin</span>=<span class="hljs-string">&#x27;/var/log/mysql/binlog/atguigu-bin&#x27;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">#  修改权限</span><br><span class="hljs-attr">在容器中</span> <span class="hljs-string">/var/log/mysql 下执行</span><br><span class="hljs-attr">mkdir</span> <span class="hljs-string">binlog</span><br><span class="hljs-attr">chown</span> <span class="hljs-string">-R -v mysql:mysql binlog</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 重启 MySQL 服务之后，新的二进制文件将出现在容器内的 /var/log/mysql/binlog文件夹下和服务器的/mydata/mysql/log/binlog</span><br><br><span class="hljs-attr">mysql&gt;</span> <span class="hljs-string">show variables like &#x27;%log_bin%&#x27;;</span><br><span class="hljs-attr">+-------------------------------+---------------------------------------+</span><br><span class="hljs-attr">|Variable_name</span>                  <span class="hljs-string">|Value                                  |</span><br><span class="hljs-attr">+-------------------------------+---------------------------------------+</span><br><span class="hljs-attr">|log_bin</span>                        <span class="hljs-string">|ON                                     |</span><br><span class="hljs-attr">|log_bin_basename</span>               <span class="hljs-string">|/var/log/mysql/binlog/atguigu-bin      |</span><br><span class="hljs-attr">|log_bin_index</span>                  <span class="hljs-string">|/var/log/mysql/binlog/atguigu-bin.index|</span><br><span class="hljs-attr">|log_bin_trust_function_creators|OFF</span>                                    <span class="hljs-string">|</span><br><span class="hljs-attr">|log_bin_use_v1_row_events</span>      <span class="hljs-string">|OFF                                    |</span><br><span class="hljs-attr">|sql_log_bin</span>                    <span class="hljs-string">|ON                                     |</span><br><span class="hljs-attr">+-------------------------------+---------------------------------------+</span><br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>数据库文件最好不要与日志文件放在同一个磁盘上！当数据库文件所在的磁盘发生故障时，可以使用日志文件恢复数据。</p>
</blockquote>
<p><strong>方式2：临时性方式</strong></p>
<p>如果不希望通过修改配置文件并重启的方式设置二进制日志的话，还可以使用如下指令，需要注意的是在 <code>MySQL 8</code> 中只有<strong>会话级别</strong>的设置，没有了global级别的设置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># MySQL 5.7<br># global 级别<br>mysql&gt; set global sql_log_bin=0;<br> Variable &#x27;sql_log_bin&#x27; can`t be set to the value of &#x27;0&#x27;<br><br># session级别<br>mysql&gt; SET sql_log_bin=0;<br>Query OK, 0 rows affected (0.01 秒)<br><br><br># MySQL 8<br># global 级别<br>mysql&gt; set global sql_log_bin=0;<br>ERROR 1228 (HY000): Variable &#x27;sql_log_bin&#x27; is a SESSION variable and can`t be used<br>with SET GLOBAL<br><br># session级别<br>mysql&gt; SET sql_log_bin=0;<br>Query OK, 0 rows affected (0.01 秒)<br></code></pre></td></tr></table></figure>

<h3 id="5-3-查看日志"><a href="#5-3-查看日志" class="headerlink" title="5.3 查看日志"></a>5.3 查看日志</h3><p>当 <code>MySQL</code> 创建二进制日志文件时，先创建一个以 <code>filename</code> 为名称，以 <code>.index</code> 为后缀的文件，再创建一个以 <code>filename</code> 为名称、以 <code>.000001</code> 为后缀的文件。</p>
<p>MySQL服务重新启动一次 ，以 <code>.000001</code> 为后缀的文件就会增加一个，并且后缀名按1递增。即日志文件的个数与 <code>MySQL</code> 服务启动的次数相同；如果日志长度超过了 <code>max_binlog_size</code> 的上限（默认是1GB），就会创建一个新的日志文件。</p>
<p>查看当前的二进制日志文件列表及大小。指令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># MySQL 5.7<br>mysql&gt; SHOW BINARY LOGS;<br>+------------------+---------+<br>|Log_name          |File_size|<br>+------------------+---------+<br>|atguigu-bin.000001|154      |<br>+------------------+---------+<br><br># MySQL 8<br>mysql&gt; SHOW BINARY LOGS;<br>+--------------------+-----------+-----------+<br>| Log_name           | File_size | Encrypted |<br>+--------------------+-----------+-----------+<br>| atguigu-bin.000001 | 156       | No        |<br>+--------------------+-----------+-----------+<br></code></pre></td></tr></table></figure>

<p>以下以 <code>MySQL 5.7</code> 为例，所有对数据库的修改都会记录在 <code>binlog</code> 中。但 <code>binlog</code> 是二进制文件，无法直接查看，想要更直观的观测它就要借助<code>mysqlbinlog</code>命令工具了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">在查看执行，先执行一条SQL语句，如下<br>INSERT INTO atguigudb4.student (<span class="hljs-built_in">id</span>, name, class) VALUES (22, <span class="hljs-string">&#x27;姝姝&#x27;</span>, <span class="hljs-string">&#x27;一班&#x27;</span>)<br><br>docker <span class="hljs-built_in">exec</span> -it mysql /bin/bash<br><br>mysqlbinlog <span class="hljs-string">&quot;/var/log/mysql/binlog/atguigu-bin.000001&quot;</span><br><br><span class="hljs-comment">#  报错</span><br>mysqlbinlog: [ERROR] unknown variable <span class="hljs-string">&#x27;default-character-set=utf8&#x27;</span><br><span class="hljs-comment"># 解决方式1：</span><br><br><span class="hljs-comment"># 解决方式2：</span><br>mysqlbinlog --no-defaults <span class="hljs-string">&quot;/var/log/mysql/binlog/atguigu-bin.000001&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="/Resources/image-20230627161349123.png" srcset="/img/loading.gif" lazyload alt="image-20230627161349123"></p>
<p>执行结果可以看到，这是一个简单的日志文件，日志中记录了用户的一些操作，这里并没有出现具体的SQL语句，这是因为<code>binlog</code> 关键字后面的内容是经过编码后的二进制日志。</p>
<p>这里一个update语句包含如下事件</p>
<ul>
<li><code>Query</code>：负责开始一个事务(BEGIN)</li>
<li><code>Table_map</code>：负责映射需要的表</li>
<li><code>Update_rows</code>：负责写入数据</li>
<li><code>Xid</code>：负责结束事务</li>
</ul>
<p>下面命令将行事件以伪SQL的形式表现出来：在最后几行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqlbinlog --no-defaults -v <span class="hljs-string">&quot;/var/log/mysql/binlog/atguigu-bin.000001&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="/Resources/image-20230627161613123.png" srcset="/img/loading.gif" lazyload alt="image-20230627161613123"></p>
<p>前面的命令同时显示binlog格式的语句，使用如下命令不显示它</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqlbinlog --no-defaults -v  --base64-output=DECODE-ROWS <span class="hljs-string">&quot;/var/log/mysql/binlog/atguigu-bin.000001&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="/Resources/image-20230627161902409.png" srcset="/img/loading.gif" lazyload alt="image-20230627161902409"></p>
<p>关于 <code>mysqlbinlog</code> 工具的使用技巧还有很多，例如只解析对某个库的操作或者某个时间段内的操作等。简单分享几个常用的语句，更多操作可以参考官方文档。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 可查看参数帮助<br>mysqlbinlog --no-defaults --help<br><br># 查看最后100行<br>mysqlbinlog --no-defaults --base64-output=decode-rows -vv &quot;/var/log/mysql/binlog/atguigu-bin.000001&quot; |tail -100<br><br># 根据position查找<br>mysqlbinlog --no-defaults --base64-output=decode-rows -vv &quot;/var/log/mysql/binlog/atguigu-bin.000001&quot; |grep -A 20 &#x27;4939002&#x27; <br></code></pre></td></tr></table></figure>

<p>上面这种办法读取出binlog日志的全文内容比较多，不容易分辨查看到pos点信息，下面介绍一种更为方便的查询命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show binlog events [IN &#x27;log_name&#x27;] [FROM pos] [LIMIT [offset,] row_count];<br></code></pre></td></tr></table></figure>

<ul>
<li><code>IN &#39;log_name&#39;</code> ：指定要查询的binlog文件名（不指定就是第一个binlog文件）　 </li>
<li><code>FROM pos</code> ：指定从哪个pos起始点开始查起（不指定就是从整个文件首个pos点开始算） </li>
<li><code>LIMIT [offset]</code> ：偏移量(不指定就是0) </li>
<li><code>row_count</code> :查询总条数（不指定就是所有行）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show binlog events in &#x27;atguigu-bin.000001&#x27;;<br>+------------------+---+--------------+---------+-----------+-------------------------------------+<br>|Log_name          |Pos|Event_type    |Server_id|End_log_pos|Info                                 |<br>+------------------+---+--------------+---------+-----------+-------------------------------------+<br>|atguigu-bin.000001|4  |Format_desc   |1        |123        |Server ver: 5.7.36-log, Binlog ver: 4|<br>|atguigu-bin.000001|123|Previous_gtids|1        |154        |                                     |<br>|atguigu-bin.000001|154|Anonymous_Gtid|1        |219        |SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27; |<br>|atguigu-bin.000001|219|Query         |1        |297        |BEGIN                                |<br>|atguigu-bin.000001|297|Table_map     |1        |359        |table_id: 108 (atguigudb4.student)   |<br>|atguigu-bin.000001|359|Write_rows    |1        |413        |table_id: 108 flags: STMT_END_F      |<br>|atguigu-bin.000001|413|Xid           |1        |444        |COMMIT /* xid=18 */                  |<br>+------------------+---+--------------+---------+-----------+-------------------------------------+<br></code></pre></td></tr></table></figure>

<p>上面这条语句可以将指定的 <code>binlog</code> 日志文件，分成有效事件行的方式返回，并可使用 <code>limit</code> 指定pos点的起始偏移，查询条数。如从 <code>Anonymous_Gtid</code> 到 <code>Xid</code> 为一个有效事件，为之前的插入数据操作。</p>
<p>其它举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">#a、查询第一个最早的binlog日志:<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> binlog events;<br>#b、指定查询atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span>这个文件<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> binlog events <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;atguigu-bin.000001&#x27;</span>;<br>#c、指定查询atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span>这个文件，从pos点:<span class="hljs-number">391</span>开始查起:<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> binlog events <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;atguigu-bin.000001&#x27;</span> <span class="hljs-keyword">from</span> <span class="hljs-number">219</span>;<br>#d、指定查询atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span>这个文件，从pos点:<span class="hljs-number">391</span>开始查起，查询<span class="hljs-number">5</span>条（即<span class="hljs-number">5</span>条语句)<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> binlog events <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;atguigu-bin.000001&#x27;</span> <span class="hljs-keyword">from</span> <span class="hljs-number">219</span> limit <span class="hljs-number">5</span>;<br>#e、指定查询atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span>这个文件，从pos点:<span class="hljs-number">391</span>开始查起，偏移<span class="hljs-number">2</span>行（即中间跳过<span class="hljs-number">2</span>个）查询<span class="hljs-number">5</span>条（即<span class="hljs-number">5</span>条语句)。<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> binlog events <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;atguigu-bin.000001&#x27;</span> <span class="hljs-keyword">from</span> <span class="hljs-number">219</span> limit <span class="hljs-number">2</span>,<span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure>

<p>上面我们讲了这么多都是基于 <code>binlog</code> 的默认格式，<code>binlog</code> 格式查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show variables like &#x27;binlog_format&#x27;;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| binlog_format | ROW   |<br>+---------------+-------+<br></code></pre></td></tr></table></figure>

<p>除此之外，<code>binlog</code> 还有2种格式，分别是<code>Statement</code>和<code>Mixed</code></p>
<ul>
<li><p><code>Statement</code></p>
<p>每一条会修改数据的sql都会记录在binlog中。</p>
<p>优点：不需要记录每一行的变化，减少了binlog日志量，节约了IO，提高性能。</p>
</li>
<li><p><code>Row</code></p>
<p>5.1.5版本的MySQL才开始支持row level 的复制，它不记录sql语句上下文相关信息，仅保存哪条记录被修改。</p>
<p>优点：row level 的日志内容会非常清楚的记录下每一行数据修改的细节。而且不会出现某些特定情况下的存储过程，或function，以及trigger的调用和触发无法被正确复制的问题。</p>
</li>
<li><p><code>Mixed</code></p>
<p>从5.1.8版本开始，MySQL提供了Mixed格式，实际上就是Statement与Row的结合。</p>
<p>详细情况，下章讲解。</p>
</li>
</ul>
<h3 id="5-4-使用日志恢复数据"><a href="#5-4-使用日志恢复数据" class="headerlink" title="5.4 使用日志恢复数据"></a>5.4 使用日志恢复数据</h3><p>如果 <code>MySQL</code> 服务器启用了二进制日志，在数据库出现意外丢失数据时，可以使用 <code>mysqlbinlog</code> 工具从指定的时间点开始直到现在或另一个指定的时间点的日志中回复数据。</p>
<p>恢复数据的命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqlbinlog [option] filename|mysql –uuser -ppassword;<br></code></pre></td></tr></table></figure>

<p>部分参数说明：</p>
<ul>
<li><p><code>filename</code> ：是日志文件名。</p>
</li>
<li><p><code>option</code> ：可选项，比较重要的两对option参数是 <code>--start-date</code>、<code>--stop-date</code> 和 <code>--start-position</code>、<code>-- stop-position</code>。</p>
<ul>
<li><code>--start-date</code> 和<code> --stop-date</code> ：可以指定恢复数据库的<strong>起始时间点</strong>和<strong>结束时间点</strong>。</li>
<li><code>--start-position</code>和<code>--stop-position</code> ：可以指定恢复数据的<strong>开始位置</strong>和<strong>结束位置</strong>。</li>
</ul>
</li>
</ul>
<p>以下使用 <code>MySQL 5.7</code> 指定恢复数据库的<strong>起始时间点</strong>和<strong>结束时间点</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 具体的恢复时间可以使用mysqlbinlog <span class="hljs-comment">--no-defaults --base64-output=decode-rows -vv &quot;/var/log/mysql/binlog/atguigu-bin.000001&quot; </span><br># 通过看伪<span class="hljs-keyword">SQL</span>代码，得到大致的时间<br><span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>mysqlbinlog <span class="hljs-comment">--no-defaults --start-datetime=&quot;2023-06-26 10:29:37&quot; --stop-datetime=&quot;2023-06-27 10:29:37&quot; --database=atguigudb4 /var/log/mysql/binlog/atguigu-bin.000001 | /usr/bin/mysql -uroot -p数据库密码 -v atguigudb4</span><br></code></pre></td></tr></table></figure>

<p>以下使用 <code>MySQL 5.7</code> 指定恢复数据的<strong>开始位置</strong>和<strong>结束位置</strong>进行恢复。</p>
<ol>
<li><p>查看 <code>bin-log</code> ，此时的bin-log记录的只有姝姝一条记录。(之前的数据没有记录到 <code>binlog</code> 日志中)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-type">BINARY</span> LOGS;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>Log_name          <span class="hljs-operator">|</span>File_size<span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span><span class="hljs-operator">|</span><span class="hljs-number">444</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>将表student中的数据删除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> atguigudb4.student <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>
</li>
<li><p>重新创建一个日志</p>
<p>目的：接下来所有操作的数据都会写入到日志2中，日志1中不会再写入任何数据(方便根据日志1的内容恢复数据，因为日志1的数据就是备份之后到删库之前的所有操作日志，重建日志2不会有过多的数据影响恢复)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> flush logs;<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-type">BINARY</span> LOGS;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>Log_name          <span class="hljs-operator">|</span>File_size<span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span><span class="hljs-operator">|</span><span class="hljs-number">1593</span>     <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000002</span><span class="hljs-operator">|</span><span class="hljs-number">154</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>查看 <code>bin-log</code> 文件，因为记录了删除的操作，所以我们需要恢复到删除数据的时候，即509之前（从 <code>Query</code> 到  <code>Anonymous_Gtid</code> ）</p>
</li>
</ol>
<p><img src="/Resources/image-20230628100420165.png" srcset="/img/loading.gif" lazyload alt="image-20230628100420165"></p>
<ol start="5">
<li><p>恢复数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>mysqlbinlog <span class="hljs-comment">--no-defaults --start-position=297 --stop-position=509 --database=atguigudb4 /var/log/mysql/binlog/atguigu-bin.000001 | /usr/bin/mysql -uroot -p数据库密码 -v atguigudb4</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>恢复结果如下：</p>
</li>
</ol>
<p><img src="/Resources/image-20230627171742366.png" srcset="/img/loading.gif" lazyload alt="image-20230627171742366"></p>
<p><img src="/Resources/image-20230627171809418.png" srcset="/img/loading.gif" lazyload alt="image-20230627171809418"></p>
<blockquote>
<p>注意：使用 <code>mysqlbinlog</code> 命令进行恢复操作时，必须是编号小的先恢复，例如 <code>atguigu-bin.000001</code>必须在 <code>atguigu-bin.000002</code> 之前恢复。</p>
</blockquote>
<h3 id="5-5-删除二进制日志"><a href="#5-5-删除二进制日志" class="headerlink" title="5.5 删除二进制日志"></a>5.5 删除二进制日志</h3><p><code>MySQL</code> 的二进制文件可以配置自动删除，同时 <code>MySQL</code> 也提供了安全的手动删除二进制文件的方法。 <code>PURGE MASTER LOGS</code> 只删除指定部分的二进制日志文件， <code>RESET MASTER</code> 删除所有的二进制日志文件。具体如下：</p>
<p><strong>1. PURGE MASTER LOGS：删除指定日志文件</strong></p>
<p>PURGE MASTER LOGS语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; PURGE &#123;MASTER | BINARY&#125; LOGS TO &#x27;指定日志文件名&#x27;<br>mysql&gt; PURGE &#123;MASTER | BINARY&#125; LOGS BEFORE &#x27;指定日期&#x27;<br></code></pre></td></tr></table></figure>

<p>准备数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 多次使用flush logs;生成多个bin<span class="hljs-operator">-</span>log文件，便于测试<br>mysql<span class="hljs-operator">&gt;</span> flush logs;<br></code></pre></td></tr></table></figure>

<p><strong>举例1</strong>：使用 <code>PURGE MASTER LOGS</code> 语句删除创建时间比 <code>atguigu-bin.000005</code> 早的所有日志</p>
<p>(1）显示二进制日志文件列表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-type">BINARY</span> LOGS;<br><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>Log_name          <span class="hljs-operator">|</span>File_size<span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000001</span><span class="hljs-operator">|</span><span class="hljs-number">1593</span>     <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000002</span><span class="hljs-operator">|</span><span class="hljs-number">493</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000003</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000004</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000005</span><span class="hljs-operator">|</span><span class="hljs-number">154</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br></code></pre></td></tr></table></figure>

<p>(2）执行PURGE MASTER LOGS语句删除创建时间比 <code>binlog.000005</code> 早的所有日志</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> PURGE MASTER LOGS <span class="hljs-keyword">TO</span> &quot;atguigu-bin.000005&quot;;<br></code></pre></td></tr></table></figure>

<p>(3）显示二进制日志文件列表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-type">BINARY</span> LOGS;<br><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>Log_name          <span class="hljs-operator">|</span>File_size<span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000005</span><span class="hljs-operator">|</span><span class="hljs-number">154</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br></code></pre></td></tr></table></figure>

<p>比 <code>binlog.000005</code> 早的所有日志文件都已经被删除了。</p>
<p><strong>举例2</strong>：使用 <code>PURGE MASTER LOGS</code> 语句删除 2022 年 06 月 28 日前创建的所有日志文件。29日再做一次</p>
<p>(1）显示二进制日志文件列表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-type">BINARY</span> LOGS;<br><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>Log_name          <span class="hljs-operator">|</span>File_size<span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000005</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000006</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000007</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000008</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000009</span><span class="hljs-operator">|</span><span class="hljs-number">203</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>atguigu<span class="hljs-operator">-</span>bin<span class="hljs-number">.000010</span><span class="hljs-operator">|</span><span class="hljs-number">154</span>      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+---------+</span><br></code></pre></td></tr></table></figure>

<p>(2）执行 <code>mysqlbinlog</code> 命令查看二进制日志文件 <code>binlog.000010</code> 的内容</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysqlbinlog <span class="hljs-comment">--no-defaults &quot;/var/log/mysql/binlog/atguigu-bin.000010&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="/Resources/image-20230628103112912.png" srcset="/img/loading.gif" lazyload alt="image-20230628103112912"></p>
<p>结果可以看出 20220628 为日志创建的时间，即 2022 年 06 月 28 日。</p>
<p>(3）使用PURGE MASTER LOGS语句删除 2022 年 06 月 28 日前创建的所有日志文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> PURGE MASTER LOGS before <span class="hljs-string">&#x27;20220628&#x27;</span>;<br></code></pre></td></tr></table></figure>


<p>(4）显示二进制日志文件列表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-type">BINARY</span> LOGS;<br></code></pre></td></tr></table></figure>

<p><strong>2. RESET MASTER：删除所有二进制日志文件</strong></p>
<p>使用 <code>RESET MASTER</code> 语句，清空所有的 <code>binlog</code> 日志。<code>MySQL</code> 会重新创建二进制文件，新的日志文件扩展名将重新从<code>000001</code> 开始编号。慎用!<br><strong>举例</strong>：使用 <code>RESET MASTER</code> 语句删除所有日志文件。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">RESET MASTER<br></code></pre></td></tr></table></figure>

<p>执行完该语句后，原来的所有二进制日志已经全部被删除。</p>
<h3 id="5-6-其它场景"><a href="#5-6-其它场景" class="headerlink" title="5.6 其它场景"></a>5.6 其它场景</h3><p>二进制日志可以通过数据库的全量备份和二进制日志中保存的增量信息，完成数据库的无损失恢复。 但是，如果遇到数据量大、数据库和数据表很多（比如分库分表的应用）的场景，用二进制日志进行数据恢复，是很有挑战性的，因为起止位置不容易管理。</p>
<p>在这种情况下，一个有效的解决办法是<strong>配置主从数据库服务器</strong>，甚至<strong>是一主多从</strong>的架构，把二进制日志文件的内容通过中继日志，同步到从数据库服务器中，这样就可以有效避免数据库故障导致的数据异常等问题。</p>
<h2 id="6-再谈二进制日志-bin-log"><a href="#6-再谈二进制日志-bin-log" class="headerlink" title="6. 再谈二进制日志(bin log)"></a>6. 再谈二进制日志(bin log)</h2><h3 id="6-1-写入机制"><a href="#6-1-写入机制" class="headerlink" title="6.1 写入机制"></a>6.1 写入机制</h3><p><code>binlog</code>的写入时机也非常简单，事务执行过程中，先把日志写到<code>binlog cache</code>，事务提交的时候，再把<code>binlog cache</code>写到<code>binlog</code>文件中。</p>
<p>因为一个事务的<code>binlog</code>不能被拆开，无论这个事务多大，也要确保一次性写入，所以系统会给每个线程分配一个块内存作为<code>binlog cache</code>。</p>
<p>我们可以通过<code>binlog_cache_size</code>参数控制单个线程 <code>binlog cache</code> 大小，如果存储内容超过了这个参数，就要暂存到磁盘（<code>Swap</code>）。</p>
<p><code>binlog</code>日志刷盘流程如下</p>
<p><img src="/Resources/04-20220305234747840.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<blockquote>
<ul>
<li>上图的 <code>write</code>，是指把日志写入到文件系统的 <code>page cache</code>，并没有把数据持久化到磁盘，所以速度比较快</li>
<li>上图的 <code>fsync</code>，才是将数据持久化到磁盘的操作</li>
</ul>
</blockquote>
<p><code>write</code> 和 <code>fsync</code> 的时机，可以由参数 <code>sync_binlog</code> 控制，默认是 <code>0</code> 。</p>
<p>当 <code>sync_binlog = 0</code> 表示每次提交事务都只 <code>write</code>，由系统自行判断什么时候执行 <code>fsync</code>。虽然性能得到提升，但是机器宕机，<code>page cache</code>里面的 <code>binlog</code> 会丢失。</p>
<p><img src="/Resources/05-20220305234754405.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>当 <code>sync_binlog = 1</code> 表示每次提交事务都会执行<code>fsync</code> ，与 <strong>redo log 的默认刷盘策略一致</strong>，提交事务后主动 <code>fsync</code>。</p>
<p>当 <code>sync_binlog = N</code> 表示每次提交事务都 <code>write</code>，但累积 <code>N</code> 个事务后才 <code>fsync</code>。在出现 <code>IO</code> 瓶颈的场景里，将<code>sync_binlog</code>设置成一个比较大的值，可以提升性能。但同样的，如果机器宕机，会丢失最近<code>N</code>个事务的<code>binlog</code>日志。</p>
<p><img src="/Resources/06-20220305234801592.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<blockquote>
<p>参考：<a href="%E7%AC%AC14%E7%AB%A0%20MySQL%20%E6%97%A5%E5%BF%97.md#2.%20%E6%80%BB%E7%BB%93">redo log的刷盘策略</a></p>
</blockquote>
<h3 id="6-2-binlog与redo-log对比"><a href="#6-2-binlog与redo-log对比" class="headerlink" title="6.2 binlog与redo log对比"></a>6.2 binlog与redo log对比</h3><ul>
<li><code>redo log</code> 是物理日志，记录内容是“在某个数据页上做了什么修改”，属于 <code>InnoDB</code> 存储引擎。</li>
<li><code>binlog</code> 是逻辑日志，记录内容是语句的原始逻辑，类似于“给 ID&#x3D;2 这一行的 c 字段加 1”，属于<code>MySQL Server</code> 层。</li>
<li>虽然它们都属于持久化的保证，但是侧重点不同。<ul>
<li><code>redo log</code>（重做日志）让<code>InnoDB</code>存储引擎拥有了崩溃恢复能力。</li>
<li><code>binlog</code>（归档日志）保证了<code>MySQL</code>集群架构的数据一致性。</li>
</ul>
</li>
</ul>
<h3 id="6-3-两阶段提交"><a href="#6-3-两阶段提交" class="headerlink" title="6.3 两阶段提交"></a>6.3 两阶段提交</h3><blockquote>
<p>引入</p>
</blockquote>
<p>在执行更新语句过程，会记录 <code>redo log</code> 与 <code>binlog</code> 两块日志，以基本的事务为单位，<code>redo log</code>在事务执行过程中可以不断写入，而<code>binlog</code>只有在提交事务时才写入，所以<code>redo log</code>与<code>binlog</code>的写入时机不一样。</p>
<p><img src="/Resources/01-20220305234816065.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>由于写入时机不一样，假如执行过程中写完 <code>redo log</code> 日志后，<code>binlog</code> 日志写期间发生了异常，这时候 <code>binlog</code> 里面没有对应的修改记录。因此，之后用<code>binlog</code>日志恢复数据时，就会少这一次更新，最终导致<strong>数据不一致</strong>问题。</p>
<p>以<code>update</code>语句为例，假设<code>id=2</code>的记录，字段<code>c</code>值是<code>0</code>，把字段<code>c</code>值更新成<code>1</code>，<code>SQL</code>语句为<code>update T set c=1 where id=2</code>，在<code>binlog</code>日志写期间发生了异常。</p>
<p>之后用<code>binlog</code>日志恢复数据时，就会少这一次更新，恢复出来的这一行<code>c</code>值是<code>0</code>，而原库因为<code>redo log</code>日志恢复，这一行<code>c</code>值是<code>1</code>，最终数据不一致。</p>
<p><img src="/Resources/02-20220305234828662.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/Resources/03-20220305235104445.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>为了解决两份日志之间的逻辑一致问题，<code>InnoDB</code>存储引擎使用<strong>两阶段提交</strong>方案。</p>
<p>原理很简单，将 <code>redo log</code> 的写入拆成了两个步骤 <code>prepare</code> 和 <code>commit</code>，这就是<strong>两阶段提交</strong>。</p>
<p><img src="/Resources/04-20220305234956774.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>使用<strong>两阶段提交</strong>后，写入 <code>binlog</code> 时发生异常也不会有影响，因为 <code>MySQL</code> 根据 <code>redo log</code> 日志恢复数据时，发现 <code>redo log</code> 还处于<code>prepare</code>阶段，并且没有对应 <code>binlog</code> 日志，就会回滚该事务。</p>
<p><img src="/Resources/05-20220305234937243.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>再看一个场景，<code>redo log</code>设置<code>commit</code>阶段发生异常，那会不会回滚事务呢？</p>
<p><img src="/Resources/06-20220305234907651.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>并不会回滚事务，它会执行上图框住的逻辑，虽然 <code>redo log</code> 是处于 <code>prepare</code> 阶段，但是能通过事务 <code>id</code> 找到对应的 <code>binlog</code> 日志，所以 <code>MySQL</code> 认为是完整的，就会提交事务恢复数据。</p>
<h2 id="7-中继日志-relay-log"><a href="#7-中继日志-relay-log" class="headerlink" title="7. 中继日志(relay log)"></a>7. 中继日志(relay log)</h2><h3 id="7-1-介绍"><a href="#7-1-介绍" class="headerlink" title="7.1 介绍"></a>7.1 介绍</h3><p><strong>中继日志只在主从服务器架构的从服务器上存在</strong>。从服务器为了与主服务器保持一致，要从主服务器读取二进制日志的内容，并且把读取到的信息写入本地的日志文件中，这个<strong>从服务器本地的日志文件</strong>就叫<strong>中继日志</strong>。然后，从服务器读取中继日志，并根据中继日志的内容对从服务器的数据进行更新，完成主从服务器的 <a href="%E7%AC%AC18%E7%AB%A0%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.md#2.1%20%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90">数据同步</a>。</p>
<p>搭建好主从服务器之后，中继日志默认会保存在从服务器的数据目录下。</p>
<p>文件名的格式是：<code> 从服务器名 -relay-bin.序号</code> 。中继日志还有一个索引文件：<code>从服务器名 -relaybin.index</code> ，用来定位当前正在使用的中继日志。</p>
<h3 id="7-2-查看中继日志"><a href="#7-2-查看中继日志" class="headerlink" title="7.2 查看中继日志"></a>7.2 查看中继日志</h3><p>中继日志与二进制日志的格式相同，可以用 <code>mysqlbinlog</code> 工具进行查看。下面是中继日志的一个片段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SET TIMESTAMP=1618558728/*!*/;<br>BEGIN<br>/*!*/;<br># at 950<br>#210416 15:38:48 server id 1 end_log_pos 832 CRC32 0xcc16d651 Table_map:<br>`atguigu`.`test` mapped to number 91<br># at 1000<br>#210416 15:38:48 server id 1 end_log_pos 872 CRC32 0x07e4047c Delete_rows: table id<br>91 flags: STMT_END_F -- server id 1 是主服务器，意思是主服务器删了一行数据<br>BINLOG &#x27;<br>CD95YBMBAAAAMgAAAEADAAAAAFsAAAAAAAEABGRlbW8ABHRlc3QAAQMAAQEBAFHWFsw=<br>CD95YCABAAAAKAAAAGgDAAAAAFsAAAAAAAEAAgAB/wABAAAAfATkBw==<br>&#x27;/*!*/;<br># at 1040<br></code></pre></td></tr></table></figure>

<p>这一段的意思是，主服务器（“server id 1”）对表 atguigu.test 进行了 2 步操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">定位到表 atguigu.test 编号是 91 的记录，日志位置是 832；<br>删除编号是 91 的记录，日志位置是 872<br></code></pre></td></tr></table></figure>

<h3 id="7-3-恢复的典型错误"><a href="#7-3-恢复的典型错误" class="headerlink" title="7.3 恢复的典型错误"></a>7.3 恢复的典型错误</h3><p>如果从服务器宕机，有的时候为了系统恢复，要重装操作系统，这样就可能会导致你的服务器名称与之前不同。而中继日志里是包含从服务器名的。在这种情况下，就可能导致你恢复从服务器的时候，无法从宕机前的中继日志里读取数据，以为是日志文件损坏了，其实是名称不对了。</p>
<p>解决的方法也很简单，把从服务器的名称改回之前的名称。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Database/" class="category-chain-item">Database</a>
  
  
    <span>></span>
    
  <a href="/categories/Database/MySQL/" class="category-chain-item">MySQL</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/MySQL/">#MySQL</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>第17章 其他数据库日志</div>
      <div>http://conquers.github.io/posts/1c2dcbdd.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>wtt</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月27日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
